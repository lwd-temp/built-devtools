{"version":3,"file":"ExplainPopover.js","sourceRoot":"","sources":["../../../../../../front_end/panels/explain/ExplainPopover.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Marked from '../../third_party/marked/marked.js';\nimport * as Buttons from '../../ui/components/buttons/buttons.js';\nimport * as MarkdownView from '../../ui/components/markdown_view/markdown_view.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nconst surveyLink =\n    'https://docs.google.com/forms/d/e/1FAIpQLSfKm4UX5PvTkM-N6aZ2UcaNyRhoP075Hr-lOmRaJv_4zN4kkQ/viewform';\n\nexport class ExplainPopover {\n  #source: Source;\n  #contentElement = document.createElement('div');\n  #markdownElement: Element;\n  #answer = '';\n  #prompt = '';\n\n  #detectOutsideInteraction = (event: Event): void => {\n    const el = event?.composedPath()[0] as Node;\n    if (!el.isDescendant(this.#contentElement) && this.#contentElement !== el) {\n      this.hide();\n    }\n  };\n  #popover = UI.PopoverHelper.PopoverHelper.createPopover();\n\n  constructor(source: Source) {\n    this.#source = source;\n    this.#contentElement.style.padding = '16px';\n    this.#contentElement.style.maxWidth = '500px';\n    this.#contentElement.innerHTML = `\n      <div class=\"markdown\">\n      </div>\n      <div class=\"rating\">\n        <span>Rate this response:</span>\n      </div>\n    `;\n    this.#popover.contentElement.classList.toggle('has-padding', false);\n    this.#popover.contentElement.appendChild(this.#contentElement);\n    this.#markdownElement = this.#contentElement.querySelector('.markdown') as HTMLDivElement;\n    const ratingContainer = this.#contentElement.querySelector('.rating') as HTMLDivElement;\n    ratingContainer.style.display = 'none';\n    ratingContainer.style.flexDirection = 'row';\n    ratingContainer.style.alignItems = 'center';\n    const plusButton = new Buttons.Button.Button();\n    plusButton.data = {\n      variant: Buttons.Button.Variant.TOOLBAR,\n      size: Buttons.Button.Size.TINY,\n      iconName: 'thumb-up',\n    };\n    plusButton.classList.add('plus');\n    plusButton.style.marginLeft = '1em';\n    plusButton.style.width = '20px';\n    plusButton.style.height = '20px';\n    const minusButton = new Buttons.Button.Button();\n    minusButton.data = {\n      variant: Buttons.Button.Variant.TOOLBAR,\n      size: Buttons.Button.Size.TINY,\n      iconName: 'thumb-down',\n    };\n    minusButton.classList.add('minus');\n    minusButton.style.width = '20px';\n    minusButton.style.height = '20px';\n    ratingContainer.append(plusButton);\n    ratingContainer.append(minusButton);\n\n    this.#contentElement.addEventListener('click', event => {\n      const isPlus = (event.target as HTMLElement).matches('.plus');\n      const isMinus = (event.target as HTMLElement).matches('.minus');\n      if (isMinus || isPlus) {\n        const rating = isMinus ? 'Bad' : 'Good';\n        Host.InspectorFrontendHost.InspectorFrontendHostInstance.openInNewTab(\n            `${surveyLink}?usp=pp_url&entry.1692896504=${encodeURIComponent(rating)}&entry.1188367343=${\n                encodeURIComponent(this.#prompt)}&entry.405375461=${encodeURIComponent(this.#answer)}` as\n            Platform.DevToolsPath.UrlString);\n      }\n    });\n  }\n\n  #renderMarkdown(content: string): void {\n    const markdown = new MarkdownView.MarkdownView.MarkdownView();\n    markdown.data = {tokens: Marked.Marked.lexer(content)};\n    this.#markdownElement.removeChildren();\n    this.#markdownElement.append(markdown);\n  }\n\n  #setupListeners(): void {\n    window.addEventListener('mousedown', this.#detectOutsideInteraction);\n    window.addEventListener('focusin', this.#detectOutsideInteraction);\n    window.addEventListener('wheel', this.#detectOutsideInteraction);\n    window.addEventListener('keydown', this.#detectOutsideInteraction);\n  }\n\n  #teardownListeners(): void {\n    window.removeEventListener('mousedown', this.#detectOutsideInteraction);\n    window.removeEventListener('focusin', this.#detectOutsideInteraction);\n    window.removeEventListener('wheel', this.#detectOutsideInteraction);\n    window.removeEventListener('keydown', this.#detectOutsideInteraction);\n  }\n\n  async show(): Promise<void> {\n    this.#setupListeners();\n    this.#renderMarkdown('loading...');\n    this.#popover.setContentAnchorBox(this.#source.getAnchor());\n    this.#popover.show(document);\n    this.#popover.positionContent();\n    try {\n      this.#prompt = await this.#source.getPrompt();\n      const result = await runPrompt(this.#prompt);\n      this.#renderMarkdown(result);\n      this.#answer = result;\n      const ratingContainer = this.#contentElement.querySelector('.rating') as HTMLDivElement;\n      ratingContainer.style.display = 'flex';\n    } catch (err) {\n      this.#renderMarkdown(`loading failed: ${err.message}`);\n    }\n    this.#popover.positionContent();\n  }\n\n  hide(): void {\n    this.#popover.hide();\n    this.#teardownListeners();\n  }\n}\n\nasync function runPrompt(input: string): Promise<string> {\n  return new Promise((resolve, reject) => {\n    if (!Host.InspectorFrontendHost.InspectorFrontendHostInstance.doAidaConversation) {\n      return reject(new Error('doAidaConversation is not available'));\n    }\n    console.time('request');\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.doAidaConversation(\n        JSON.stringify({\n          input,\n          client: 'GENERAL',\n        }),\n        result => {\n          console.timeEnd('request');\n          try {\n            const results = JSON.parse(result.response);\n            const text = results\n                             .map((result: {textChunk: {text: string}}|{codeChunk: {code: string}}) => {\n                               if ('textChunk' in result) {\n                                 return result.textChunk.text;\n                               }\n                               if ('codeChunk' in result) {\n                                 return result.codeChunk.code;\n                               }\n                               throw new Error('Unknown chunk result');\n                             })\n                             .join(' ');\n            resolve(text);\n          } catch (err) {\n            reject(err);\n          }\n        });\n  });\n}\n\ninterface Source {\n  getAnchor(): AnchorBox;\n  getPrompt(): Promise<string>;\n}\n"]}