{"version":3,"file":"AnimationHandler.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/handlers/AnimationHandler.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as Types from '../types/types.js';\n\nimport {HandlerState} from './types.js';\n\nconst animations: Types.TraceEvents.TraceEventAnimation[] = [];\nconst animationsSyntheticEvents: Types.TraceEvents.TraceEventSyntheticNestableAsyncEvent[] = [];\n\nexport interface AnimationData {\n  animations: readonly Types.TraceEvents.TraceEventSyntheticNestableAsyncEvent[];\n}\nlet handlerState = HandlerState.UNINITIALIZED;\n\nexport function reset(): void {\n  animations.length = 0;\n  animationsSyntheticEvents.length = 0;\n}\n\nexport function handleEvent(event: Types.TraceEvents.TraceEventData): void {\n  if (Types.TraceEvents.isTraceEventAnimation(event)) {\n    animations.push(event);\n    return;\n  }\n}\n\nexport async function finalize(): Promise<void> {\n  const matchedEvents = matchBeginningAndEndEvents();\n\n  createSortedAnimationsSyntheticEvents(matchedEvents);\n\n  handlerState = HandlerState.FINALIZED;\n}\n\nfunction matchBeginningAndEndEvents(): Map<string, {\n  begin: Types.TraceEvents.TraceEventNestableAsyncBegin | null,\n  end: Types.TraceEvents.TraceEventNestableAsyncEnd | null,\n}> {\n  // map to store begin and end of the event\n  const matchedEvents: Map<string, {\n    begin: Types.TraceEvents.TraceEventNestableAsyncBegin | null,\n    end: Types.TraceEvents.TraceEventNestableAsyncEnd | null,\n  }> = new Map();\n\n  // looking for start and end\n  for (const event of animations) {\n    const id = event.id2;\n\n    if (id === undefined) {\n      continue;\n    }\n\n    const syntheticId = `${event.cat}:${id.local}:${event.name}`;\n\n    const otherEventsWithID = Platform.MapUtilities.getWithDefault(matchedEvents, syntheticId, () => {\n      return {begin: null, end: null};\n    });\n\n    const isStartEvent = event.ph === Types.TraceEvents.Phase.ASYNC_NESTABLE_START;\n    const isEndEvent = event.ph === Types.TraceEvents.Phase.ASYNC_NESTABLE_END;\n\n    if (isStartEvent) {\n      otherEventsWithID.begin = {\n        ...event,\n        ph: Types.TraceEvents.Phase.ASYNC_NESTABLE_START,\n        id2: {\n          local: event.id2?.local,\n        },\n        id: event.args?.id,\n      };\n    } else if (isEndEvent) {\n      otherEventsWithID.end = {\n        ...event,\n        ph: Types.TraceEvents.Phase.ASYNC_NESTABLE_END,\n        id2: {\n          local: event.id2?.local,\n        },\n        id: event.args?.id,\n      };\n    }\n  }\n\n  return matchedEvents;\n}\n\nfunction createSortedAnimationsSyntheticEvents(matchedEvents: Map<string, {\n  begin: Types.TraceEvents.TraceEventNestableAsyncBegin | null,\n  end: Types.TraceEvents.TraceEventNestableAsyncEnd | null,\n}>): void {\n  for (const [id, eventsPair] of matchedEvents.entries()) {\n    if (!eventsPair.begin || !eventsPair.end) {\n      continue;\n    }\n\n    const event: Types.TraceEvents.TraceEventSyntheticNestableAsyncEvent = {\n      cat: eventsPair.end.cat,\n      ph: eventsPair.end.ph,\n      pid: eventsPair.end.pid,\n      tid: eventsPair.end.tid,\n      id,\n      name: eventsPair.begin.name,\n      dur: Types.Timing.MicroSeconds(eventsPair.end.ts - eventsPair.begin.ts),\n      ts: eventsPair.begin.ts,\n      args: {\n        data: {\n          beginEvent: eventsPair.begin,\n          endEvent: eventsPair.end,\n        },\n      },\n    };\n\n    if (event.dur < 0) {\n      // We have seen in the backend that sometimes animation events get\n      // generated with multiple begin entries, or multiple end entries, and this\n      // can cause invalid data on the performance panel, so we drop them.\n      // crbug.com/1472375\n      continue;\n    }\n    animationsSyntheticEvents.push(event);\n  }\n\n  animationsSyntheticEvents.sort((a, b) => a.ts - b.ts);\n}\n\nexport function data(): AnimationData {\n  if (handlerState !== HandlerState.FINALIZED) {\n    throw new Error('Animation handler is not finalized');\n  }\n\n  return {\n    animations: Array.from(animationsSyntheticEvents),\n  };\n}\n"]}